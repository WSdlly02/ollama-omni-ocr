{
	# 全局配置
}

# 1. HTTP 重定向块：将所有 80 端口请求重定向到 HTTPS
:80 {
	# 使用 {host} 保持原有域名/IP，{uri} 保持原有路径
	redir https://{host}{uri} permanent
}

# 2. HTTPS 业务块：仅监听 443
:443 {
	# 使用自签名证书
	tls internal

	# 开启 gzip 压缩
	encode gzip

	# 静态文件根目录
	root * /usr/share/caddy

	# --- 路径处理 A: Ollama 反向代理 ---
	# 使用 handle_path 而不是 handle，它会自动剥离 /ollama 前缀
	# 例如：请求 /ollama/api/tags -> 发送给后端 /api/tags
	handle_path /ollama/* {
		# CORS 设置
		header {
			Access-Control-Allow-Origin *
			Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
			Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, Accept, Origin"
			Access-Control-Expose-Headers "Content-Length, Content-Range, Content-Type"
			Access-Control-Max-Age 3600
		}

		# 处理 OPTIONS 预检请求
		@options method OPTIONS
		handle @options {
			respond "" 204
		}

		# 反向代理
		# 建议：确保环境变量 OLLAMA_HOST 填写正确，如 http://host.docker.internal:11434
		reverse_proxy {$OLLAMA_HOST} {
			header_up Host {upstream_hostport}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}

	# --- 路径处理 B: 前端静态资源 (SPA) ---
	# 使用 handle 捕获其余所有请求
	handle {
		# 如果请求的文件不存在，重写到 index.html (SPA 必备)
		try_files {path} /index.html

		# 提供文件服务
		file_server
	}
}
